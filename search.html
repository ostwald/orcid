<!DOCTYPE html>
<html lang="en">
<!--<head  profile="http://www.w3.org/2005/10/profile">-->
<head >
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/jquery-ui.min.js"></script>
    <script src="utils.js"></script>
    <script src="profile-model.js"></script>
    <script src="config.js"></script>



    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="styles.css">
    <meta charset=utf-8 />
    <!--<link rel='shortcut icon' href='https://www.dropbox.com/s/80dvo44nfw1a8yo/favicon.ico?dl=0' type='image/x-icon'/ >-->

    <title>ORCID Search</title>
    <script>

    </script>
<body>

<h1>Search</h1>

<form id="search-form">
<input type="text" id="query"><button type="submit" id="search-button">Search</button>
</form>

<h2 id="results-header">Results</h2>


<table id="results-table" class="orcid-table">
    <thead>
        <tr class="header">
            <th>family name</th>
            <th>given name(s)</th>
            <th>orcid ID</th>
        </tr>
    </thead>
    <tbody id="results-body"></tbody>
</table>

<div id="response-json"></div>

</body>

<script>

// Config
var CLIENT = CONFIGS.sandbox_public
var SERVICE = CONFIGS.sandbox_service

$(function () {

    var base_uri = SERVICE.BASE_API_URL + '/search/orcid-bio';
    var params = {
        client_id : CLIENT.CLIENT_ID,
        client_secret : CLIENT.CLIENT_SECRET,
        q: 'newman'
    }
    log ("RUNNING");
    // searchProxy(base_uri, params);

    $('#search-button')
        .button()
        .click (function (event) {
            params.q = $('#query').val();
            log ("q: " + params.q);
            searchProxy(base_uri, params);
        });

    $('#search-form').submit (function (event) {

        log ('submit');
        event.preventDefault();
    });

});

function display_search_results (response_json) {
    var num_found = response_json['orcid-search-results']['num-found']
    var results = response_json['orcid-search-results']['orcid-search-result'];
    log (" - " + results.length + " to display");
    $(results).each (function (i, result) {
        try {
            if (i == 0)
                log (stringify(result));
            var profile = new Profile(result['orcid-profile']);
            log (profile.family_name)
            var profile_link = $t('a')
                .attr('href', 'profile.html?orcid=' + profile.orcid_ID)
                .html(profile.orcid_ID);

            var row = $t('tr').attr('id', profile.orcid_ID)
                .append($t('td').html(profile.family_name))
                .append($t('td').html(profile.given_names))
                // .append($t('td').html(profile.orcid_ID))
                .append($t('td').html(profile_link))

            $('#results-body').append(row);

        } catch (error) {
            log ("PROFILE error: " + error);
        }
    })
}

function searchProxy(base_url, params) {

    $.ajax ({
        url:base_url + '?' + $.param(params),
        headers : {
            'Accept' : 'application/vnd.orcid+xml',
            'Authorization' : 'Bearer'
        },
        dataType : "jsonp",
        success: function (responseJson) {
            // log ("RESPONSE: " + stringify(responseJson));

            var num_found = responseJson['orcid-search-results']['num-found']
            $('#results-header').html ('Results (' + num_found + ')');

            display_search_results (responseJson)
        }
});

}

</script>


</html>